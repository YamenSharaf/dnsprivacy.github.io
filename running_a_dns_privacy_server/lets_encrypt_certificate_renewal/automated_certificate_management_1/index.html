<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.86.0" />
    <meta name="description" content="">


    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Certificate management Method 1 :: dnsprivacy.org</title>

    
    <link href="/css/nucleus.css?1629998312" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1629998312" rel="stylesheet">
    <link href="/css/hybrid.css?1629998312" rel="stylesheet">
    <link href="/css/featherlight.min.css?1629998312" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1629998312" rel="stylesheet">
    <link href="/css/auto-complete.css?1629998312" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1629998312" rel="stylesheet">
    <link href="/css/theme.css?1629998312" rel="stylesheet">
    <link href="/css/tabs.css?1629998312" rel="stylesheet">
    <link href="/css/hugo-theme.css?1629998312" rel="stylesheet">
    
    <link href="/css/theme-blue.css?1629998312" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1629998312"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/running_a_dns_privacy_server/lets_encrypt_certificate_renewal/automated_certificate_management_1/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/'>
  <p style="color: #fafafa;font-size:36px;font-weight: 400;">DNS Privacy Project</p>
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1629998312"></script>
<script type="text/javascript" src="/js/auto-complete.js?1629998312"></script>
<script type="text/javascript">
    
        var baseurl = "http:\/\/dnsprivacy.org\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1629998312"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/the_problem/" title="The Problem" class="dd-item
        
        
        
        ">
      <a href="/the_problem/">
          1. The Problem
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/the_solutions/" title="The Solutions" class="dd-item
        
        
        
        ">
      <a href="/the_solutions/">
          2. The Solutions
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/current_work/" title="Current Work" class="dd-item
        
        
        
        ">
      <a href="/current_work/">
          3. Current Work
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/ietf_dns_privacy_tutorial/" title="IETF DNS Privacy Tutorial" class="dd-item
        
        
        
        ">
      <a href="/ietf_dns_privacy_tutorial/">
          4. IETF DNS Privacy Tutorial
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/public_resolvers/" title="Public Resolvers" class="dd-item
        
        
        
        ">
      <a href="/public_resolvers/">
          5. Public Resolvers
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/test_servers/" title="Test Servers" class="dd-item
        
        
        
        ">
      <a href="/test_servers/">
          6. Test Servers
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/test_servers/map_of_test_server_locations/" title="Map of test server locations" class="dd-item ">
        <a href="/test_servers/map_of_test_server_locations/">
        6.1. Map of test server locations
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/test_servers/monitoring/" title="dnsprivacy Monitoring" class="dd-item ">
        <a href="/test_servers/monitoring/">
        6.2. dnsprivacy Monitoring
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/test_servers/live_traffic_levels/" title="Live Traffic Levels" class="dd-item ">
        <a href="/test_servers/live_traffic_levels/">
        6.2. Live Traffic Levels
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/dns_privacy_clients/" title="DNS Privacy Clients" class="dd-item
        
        
        
        ">
      <a href="/dns_privacy_clients/">
          7. DNS Privacy Clients
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/dns_privacy_daemon_-_stubby/" title="DNS Privacy Daemon - Stubby" class="dd-item
        
        
        
        ">
      <a href="/dns_privacy_daemon_-_stubby/">
          8. DNS Privacy Daemon - Stubby
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/dns_privacy_daemon_-_stubby/about_stubby/" title="About Stubby" class="dd-item ">
        <a href="/dns_privacy_daemon_-_stubby/about_stubby/">
        8.1. About Stubby
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dns_privacy_daemon_-_stubby/configuring_stubby/" title="Configuring Stubby" class="dd-item ">
        <a href="/dns_privacy_daemon_-_stubby/configuring_stubby/">
        8.2. Configuring Stubby
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dns_privacy_daemon_-_stubby/stubby_manager_gui/" title="Stubby Manager GUI" class="dd-item ">
        <a href="/dns_privacy_daemon_-_stubby/stubby_manager_gui/">
        8.3. Stubby Manager GUI
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/dns_privacy_daemon_-_stubby/installation/" title="Installation" class="dd-item
        
        
        
        ">
      <a href="/dns_privacy_daemon_-_stubby/installation/">
          8.4. Installation
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/dns_privacy_daemon_-_stubby/installation/linux_from_source/" title="Linux From Source" class="dd-item ">
        <a href="/dns_privacy_daemon_-_stubby/installation/linux_from_source/">
        8.4.1. Linux From Source
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dns_privacy_daemon_-_stubby/installation/running_as_a_service_on_nix/" title="Running as a service on *nix" class="dd-item ">
        <a href="/dns_privacy_daemon_-_stubby/installation/running_as_a_service_on_nix/">
        8.4.2. Running as a service on *nix
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dns_privacy_daemon_-_stubby/installation/macos_homebrew/" title="MacOS Homebrew" class="dd-item ">
        <a href="/dns_privacy_daemon_-_stubby/installation/macos_homebrew/">
        8.4.3. MacOS Homebrew
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dns_privacy_daemon_-_stubby/installation/stubby_gui_for_macos/" title="Stubby GUI for macOS" class="dd-item ">
        <a href="/dns_privacy_daemon_-_stubby/installation/stubby_gui_for_macos/">
        8.4.4. Stubby GUI for macOS
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dns_privacy_daemon_-_stubby/installation/windows_installer_for_stubby/" title="Windows installer for Stubby" class="dd-item ">
        <a href="/dns_privacy_daemon_-_stubby/installation/windows_installer_for_stubby/">
        8.4.5. Windows installer for Stubby
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/implementation_status/" title="Implementation Status" class="dd-item
        
        
        
        ">
      <a href="/implementation_status/">
          9. Implementation Status
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/running_a_dns_privacy_server/" title="Running a DNS Privacy server" class="dd-item
        parent
        
        
        ">
      <a href="/running_a_dns_privacy_server/">
          10. Running a DNS Privacy server
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/running_a_dns_privacy_server/using_unbound/" title="Using Unbound" class="dd-item ">
        <a href="/running_a_dns_privacy_server/using_unbound/">
        10.1. Using Unbound
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/running_a_dns_privacy_server/using_knot_resolver/" title="Using Knot Resolver" class="dd-item ">
        <a href="/running_a_dns_privacy_server/using_knot_resolver/">
        10.2. Using Knot Resolver
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/running_a_dns_privacy_server/using_dnsdist/" title="Using dnsdist" class="dd-item ">
        <a href="/running_a_dns_privacy_server/using_dnsdist/">
        10.3. Using dnsdist
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/running_a_dns_privacy_server/using_a_tls_proxy/" title="Using a TLS proxy" class="dd-item
        
        
        
        ">
      <a href="/running_a_dns_privacy_server/using_a_tls_proxy/">
          10.4. Using a TLS proxy
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/running_a_dns_privacy_server/using_a_tls_proxy/building_haproxy_using_tlsv1_3/" title="Building HAProxy using TLSv1.3" class="dd-item ">
        <a href="/running_a_dns_privacy_server/using_a_tls_proxy/building_haproxy_using_tlsv1_3/">
        10.4.1. Building HAProxy using TLSv1.3
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/running_a_dns_privacy_server/lets_encrypt_certificate_renewal/" title="Let&#39;s Encrypt Certificate renewal" class="dd-item
        parent
        
        
        ">
      <a href="/running_a_dns_privacy_server/lets_encrypt_certificate_renewal/">
          10.5. Let&#39;s Encrypt Certificate renewal
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/running_a_dns_privacy_server/lets_encrypt_certificate_renewal/automated_certificate_management_1/" title="Certificate management Method 1" class="dd-item active">
        <a href="/running_a_dns_privacy_server/lets_encrypt_certificate_renewal/automated_certificate_management_1/">
        10.5.1. Certificate management Method 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/running_a_dns_privacy_server/lets_encrypt_certificate_renewal/automated_certificate_management_2/" title="Certificate management method 2" class="dd-item ">
        <a href="/running_a_dns_privacy_server/lets_encrypt_certificate_renewal/automated_certificate_management_2/">
        10.5.2. Certificate management method 2
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/running_a_dns_privacy_server/monitoring_privacy_servers/" title="Monitoring Privacy servers" class="dd-item ">
        <a href="/running_a_dns_privacy_server/monitoring_privacy_servers/">
        10.6. Monitoring Privacy servers
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/running_a_dns_privacy_server/best_current_practices/" title="Best Current Practices" class="dd-item
        
        
        
        ">
      <a href="/running_a_dns_privacy_server/best_current_practices/">
          10.7. Best Current Practices
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/running_a_dns_privacy_server/best_current_practices/comparison_of_policy_and_privacy_statements_2019/" title="Comparison of policy and privacy statements 2019" class="dd-item ">
        <a href="/running_a_dns_privacy_server/best_current_practices/comparison_of_policy_and_privacy_statements_2019/">
        10.7.1. Comparison of policy and privacy statements 2019
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/running_a_dns_privacy_server/best_current_practices/data_minimisation_of_dns_traffic/" title="Data minimisation of DNS traffic" class="dd-item ">
        <a href="/running_a_dns_privacy_server/best_current_practices/data_minimisation_of_dns_traffic/">
        10.7.2. Data minimisation of DNS traffic
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/dns_privacy_reference_material/" title="DNS Privacy Reference Material" class="dd-item
        
        
        
        ">
      <a href="/dns_privacy_reference_material/">
          11. DNS Privacy Reference Material
          
      </a>
      
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://github.com/dnsprivacy"><i class='fab fa-github'></i> Github repo</a>
              </li>
          
              <li>
                  <a class="padding" href="https://twitter.com/DNSPrivacyProj"><i class='fab fa-twitter'></i> Twitter</a>
              </li>
          
              <li>
                  <a class="padding" href="https://www.youtube.com/channel/UCaJWMY-m9ktZIbUNMi0Eh9g/playlists"><i class='fab fa-youtube'></i> YouTube</a>
              </li>
          
              <li>
                  <a class="padding" href="https://sinodun.com"><i class='fas fa-bookmark'></i> Sinodun IT</a>
              </li>
          
              <li>
                  <a class="padding" href="https://www.nlnetlabs.nl/"><i class='fas fa-bookmark'></i> NLnetLabs</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn">Hugo Theme Learn</a> and <a href="https://gohugo.io/">Hugo</a></p>
<p>Built by <a href="sinodun.com">Sinodun Internet Technologies.</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/'>DNS Privacy Project</a> > <a href='/running_a_dns_privacy_server/'>Running a DNS Privacy server</a> > <a href='/running_a_dns_privacy_server/lets_encrypt_certificate_renewal/'>Let's Encrypt Certificate renewal</a> > Certificate management Method 1
          
        
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#background">Background</a></li>
    <li><a href="#dns-setup">DNS setup</a>
      <ul>
        <li><a href="#cnames">CNAMES</a></li>
      </ul>
    </li>
    <li><a href="#configure-dehydrated">Configure dehydrated</a>
      <ul>
        <li><a href="#create-a-domains-file">Create a domains file</a></li>
        <li><a href="#write-a-hook-script">Write a hook script</a></li>
      </ul>
    </li>
    <li><a href="#write-a-script-to-download-the-certificates-to-your-dns-servers">Write a script to download the certificates to your DNS servers</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Certificate management Method 1
            </h1>
          

        


<div class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#background">Background</a></li>
    <li><a href="#dns-setup">DNS setup</a>
      <ul>
        <li><a href="#cnames">CNAMES</a></li>
      </ul>
    </li>
    <li><a href="#configure-dehydrated">Configure dehydrated</a>
      <ul>
        <li><a href="#create-a-domains-file">Create a domains file</a></li>
        <li><a href="#write-a-hook-script">Write a hook script</a></li>
      </ul>
    </li>
    <li><a href="#write-a-script-to-download-the-certificates-to-your-dns-servers">Write a script to download the certificates to your DNS servers</a></li>
  </ul>
</nav>
</div>
<h2 id="background">Background</h2>
<p>At Sinodun we use
dehydrated <a href="https://github.com/lukas2511/dehydrated">https://github.com/lukas2511/dehydrated</a> to manage our
certificates. Also we use the <a href="https://tools.ietf.org/html/draft-ietf-acme-acme-09#section-8.5">dns-01
challenge</a> to
renew them.</p>
<p>Since we run multiple DNS-over-TLS servers, the method used here employs
a single &lsquo;certificate management&rsquo; server to renew the certificates,
update the zone with the dns-01 challenge and make the renewed
certificates available via ftp. A script is then run on each DNS server
to download any new certificates using ftp to each server and restart
the DNS service. In this example we use TLS proxies in front of BIND, or
Knot resolver.</p>
<h2 id="dns-setup">DNS setup</h2>
<p>You could put the dns-01 challenge responses in your organisations main
zone. However it is more flexible to dedicate a separate zone for that,
especially if you are responsible for running the servers but someone
else or some other organisation is responsible for the DNS.</p>
<p>For authoritative DNS we use knot <a href="https://www.knot-dns.cz/">https://www.knot-dns.cz/</a> because it
has a nice interface for managing zones. The same effect could be
obtained using dynamic updates.</p>
<p>It is a good idea to sign your zone if you are going to be putting
challenge response records in it. However, the nameserver must be able
to sign updates as they are applied.</p>
<h3 id="cnames">CNAMES</h3>
<p>Lets assume that we are managing certificates for two servers
dnsovertls1.&lt;YOURDOMAIN&gt;. and dnsovertls.&lt;YOURDOMAIN&gt;.</p>
<p>Add CNAME RRs to the &lt;YOURDOMAIN&gt; zone like these. These will redirect
queries for the dns-01 challenge to a dedicated zone which can exist on
and be served by a dedicated certificate management server</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">_acme<span style="color:#f92672">-</span>challenge<span style="color:#f92672">.</span><span style="color:#a6e22e">dnsovertls1</span><span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span> 300 CNAME dnsovertls1<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span><span style="color:#a6e22e">acme</span><span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span>
_acme<span style="color:#f92672">-</span>challenge<span style="color:#f92672">.</span><span style="color:#a6e22e">dnsovertls</span><span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span> 300 CNAME dnsovertls<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span><span style="color:#a6e22e">acme</span><span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span>
</code></pre></div><p>Delegate acme.&lt;YOURDOMAIN&gt; to the certificate management server by
adding NS and DS RRs to the &lt;YOURDOMAIN&gt; zone. Lets assume the server
is called ns1.acme.&lt;YOURDOMAIN&gt;</p>
<p>Create an empty zone for acme.&lt;YOURDOMAIN&gt; (SOA and NS and A/AAAA RRs).
Configure knot to sign the domain</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">server:
  listen<span style="color:#f92672">:</span> <span style="color:#f92672">&lt;</span>YOURIP4<span style="color:#f92672">&gt;</span><span style="color:#a6e22e">@53</span>
  listen<span style="color:#f92672">:</span> <span style="color:#f92672">&lt;</span>YOURIP6<span style="color:#f92672">&gt;</span><span style="color:#a6e22e">@53</span>
  user<span style="color:#f92672">:</span> knot<span style="color:#f92672">:</span>knot

log:
  <span style="color:#f92672">-</span> target<span style="color:#f92672">:</span> syslog
    any<span style="color:#f92672">:</span> info
        
policy:
  <span style="color:#f92672">-</span> id<span style="color:#f92672">:</span> dnssec
    algorithm<span style="color:#f92672">:</span> ECDSAP256SHA256

zone:
  <span style="color:#f92672">-</span> domain<span style="color:#f92672">:</span> acme<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;</span>
    file<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;acme.&lt;YOURDOMAIN&gt;.zone&#34;</span>
    dnssec<span style="color:#f92672">-</span>signing<span style="color:#f92672">:</span> on
    dnssec<span style="color:#f92672">-</span>policy<span style="color:#f92672">:</span> dnssec
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">acme<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span>       3600    SOA     ns1<span style="color:#f92672">.</span><span style="color:#a6e22e">acme</span><span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span> user<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span> 2016120927 30000 300 604800 300
acme<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span>       3600    NS      ns1<span style="color:#f92672">.</span><span style="color:#a6e22e">acme</span><span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span>
ns1<span style="color:#f92672">.</span><span style="color:#a6e22e">acme</span><span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span>   3600    A       <span style="color:#f92672">&lt;</span>YOURIP4<span style="color:#f92672">&gt;</span>
ns1<span style="color:#f92672">.</span><span style="color:#a6e22e">acme</span><span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span>   3600    AAAA    <span style="color:#f92672">&lt;</span>YOURIP6<span style="color:#f92672">&gt;</span>
</code></pre></div><h2 id="configure-dehydrated">Configure dehydrated</h2>
<p>Get dehydrated <a href="https://github.com/lukas2511/dehydrated">https://github.com/lukas2511/dehydrated</a> and create some
config.

<div class="notices infoblock" ><p>Uncomment the first two lines until you are sure everything is working.
This will allow you to run the scripts for debugging without exceeding
the production Let&rsquo;s Encrypt limits</p>
</div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">##</span> CA<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://acme-staging.api.letsencrypt.org/directory&#34;</span>
<span style="color:#960050;background-color:#1e0010">##</span> CA_TERMS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://acme-staging.api.letsencrypt.org/terms&#34;</span>
LICENSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://letsencrypt.org/documents/LE-SA-v1.1.1-August-1-2016.pdf&#34;</span>
CERTDIR<span style="color:#f92672">=/&lt;</span>PATH<span style="color:#f92672">&gt;/</span>dehydrated<span style="color:#f92672">/</span>certs
DOMAINS_TXT<span style="color:#f92672">=/&lt;</span>PATH<span style="color:#f92672">&gt;/</span>dehydrated<span style="color:#f92672">/</span>dehydrated<span style="color:#f92672">.</span><span style="color:#a6e22e">domains</span>
CHALLENGETYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dns-01&#34;</span>
HOOK<span style="color:#f92672">=/&lt;</span>PATH<span style="color:#f92672">&gt;/</span>dehydrated<span style="color:#f92672">/</span>hook<span style="color:#f92672">.</span><span style="color:#a6e22e">sh</span>
PRIVATE_KEY_RENEW<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;no&#34;</span>
PRIVATE_KEY_ROLLOVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;no&#34;</span>
CONTACT_EMAIL<span style="color:#f92672">=</span>you AT email
</code></pre></div><p>The two PRIVATE_KEY lines ensure that the key is not replaced and so
SPKI pinning will work.</p>
<h3 id="create-a-domains-file">Create a domains file</h3>
<p>Create a dehydrated.domains file
(<em>/&lt;PATH&gt;/dehydrated/dehydrated.domains</em>)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">dnsovertls<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;</span>
dnsovertls1<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;</span>
</code></pre></div><h3 id="write-a-hook-script">Write a hook script</h3>
<p>Create a hook.sh script (<em>/&lt;PATH&gt;/dehydrated/hook.sh</em>). </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">!/</span>usr<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>env bash

set <span style="color:#f92672">-</span>e
set <span style="color:#f92672">-</span>u
set <span style="color:#f92672">-</span>o pipefail

<span style="color:#a6e22e">check_knotc_exit_code</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#f92672">!</span> $1 <span style="color:#f92672">-</span>eq 0 <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
    <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>sbin<span style="color:#f92672">/</span>knotc zone<span style="color:#f92672">-</span>abort acme<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span>
    exit 1
  fi
<span style="color:#f92672">}</span>

deploy_challenge<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  local DOMAIN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${1}.acme.&lt;YOURDOMAIN&gt;.&#34;</span> RDATA<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${3}&#34;</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;${1}&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;ns1.acme.&lt;YOURDOMAIN&gt;&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
    DOMAIN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;_acme-challenge.${1}.&#34;</span>
  fi
  echo <span style="color:#e6db74">&#34;Adding $DOMAIN 10 TXT \&#34;$RDATA\&#34;&#34;</span>
  echo <span style="color:#e6db74">&#34;zone-begin acme.&lt;YOURDOMAIN&gt;.&#34;</span>
  <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>sbin<span style="color:#f92672">/</span>knotc zone<span style="color:#f92672">-</span>begin acme<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span>
  check_knotc_exit_code $<span style="color:#f92672">?</span>
  echo <span style="color:#e6db74">&#34;zone-set acme.&lt;YOURDOMAIN&gt;. $DOMAIN 10 TXT \&#34;$RDATA\&#34;&#34;</span>
  <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>sbin<span style="color:#f92672">/</span>knotc zone<span style="color:#f92672">-</span>set acme<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span> $DOMAIN 10 TXT <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#e6db74">&#34;$RDATA\&#34;
</span><span style="color:#e6db74">  check_knotc_exit_code $?
</span><span style="color:#e6db74">  echo &#34;</span>zone<span style="color:#f92672">-</span>commit acme<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">  /usr/sbin/knotc zone-commit acme.&lt;YOURDOMAIN&gt;.
</span><span style="color:#e6db74">  check_knotc_exit_code $?
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74"> 
</span><span style="color:#e6db74">clean_challenge() {
</span><span style="color:#e6db74">   local DOMAIN=&#34;</span>$<span style="color:#f92672">{</span>1<span style="color:#f92672">}.</span><span style="color:#a6e22e">acme</span><span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span><span style="color:#e6db74">&#34; RDATA=&#34;</span>$<span style="color:#f92672">{</span>3<span style="color:#f92672">}</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">   if [[ &#34;</span>$<span style="color:#f92672">{</span>1<span style="color:#f92672">}</span><span style="color:#e6db74">&#34; == &#34;</span>ns1<span style="color:#f92672">.</span><span style="color:#a6e22e">acme</span><span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;</span><span style="color:#e6db74">&#34; ]] ; then
</span><span style="color:#e6db74">     DOMAIN=&#34;</span>_acme<span style="color:#f92672">-</span>challenge<span style="color:#f92672">.</span><span style="color:#a6e22e">$</span><span style="color:#f92672">{</span>1<span style="color:#f92672">}.</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">   fi
</span><span style="color:#e6db74">   echo &#34;</span>Removing $DOMAIN 10 TXT <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#e6db74">&#34;$RDATA\&#34;&#34;</span>
   echo <span style="color:#e6db74">&#34;zone-begin acme.&lt;YOURDOMAIN&gt;.&#34;</span>
   <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>sbin<span style="color:#f92672">/</span>knotc zone<span style="color:#f92672">-</span>begin acme<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span>
   check_knotc_exit_code $<span style="color:#f92672">?</span>
   echo <span style="color:#e6db74">&#34;zone-unset acme.&lt;YOURDOMAIN&gt;. $DOMAIN 10 TXT \&#34;$RDATA\&#34;&#34;</span>
   <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>sbin<span style="color:#f92672">/</span>knotc zone<span style="color:#f92672">-</span>unset acme<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span> $DOMAIN TXT
   check_knotc_exit_code $<span style="color:#f92672">?</span>
   echo <span style="color:#e6db74">&#34;zone-commit acme.&lt;YOURDOMAIN&gt;.&#34;</span>
   <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>sbin<span style="color:#f92672">/</span>knotc zone<span style="color:#f92672">-</span>commit acme<span style="color:#f92672">.&lt;</span>YOURDOMAIN<span style="color:#f92672">&gt;.</span>
   check_knotc_exit_code $<span style="color:#f92672">?</span>
<span style="color:#f92672">}</span>
 
deploy_cert<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
   local DOMAIN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${1}&#34;</span> KEYFILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${2}&#34;</span> CERTFILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${3}&#34;</span> FULLCHAINFILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${4}&#34;</span> CHAINFILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${5}&#34;</span> TIMESTAMP<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${6}&#34;</span>
   <span style="color:#960050;background-color:#1e0010">##</span> Copy cert <span style="color:#a6e22e">files</span> <span style="color:#f92672">(</span>not the keys<span style="color:#f92672">)</span> to your download site of choice <span style="color:#f92672">-</span> web<span style="color:#f92672">,</span> ftp etc<span style="color:#f92672">...</span>
    echo <span style="color:#e6db74">&#34;Deploying certs to ftp server&#34;</span>
    echo <span style="color:#e6db74">&#34;Deploy for domain ${DOMAIN}: ${CERTFILE} ${FULLCHAINFILE} ${CHAINFILE}&#34;</span>
    cp $<span style="color:#f92672">{</span>CERTFILE<span style="color:#f92672">}</span> <span style="color:#f92672">/</span>srv<span style="color:#f92672">/</span>ftp<span style="color:#f92672">/</span>certs<span style="color:#f92672">/</span>$<span style="color:#f92672">{</span>DOMAIN<span style="color:#f92672">}/</span>
    cp $<span style="color:#f92672">{</span>FULLCHAINFILE<span style="color:#f92672">}</span> <span style="color:#f92672">/</span>srv<span style="color:#f92672">/</span>ftp<span style="color:#f92672">/</span>certs<span style="color:#f92672">/</span>$<span style="color:#f92672">{</span>DOMAIN<span style="color:#f92672">}/</span>
    cp $<span style="color:#f92672">{</span>CHAINFILE<span style="color:#f92672">}</span> <span style="color:#f92672">/</span>srv<span style="color:#f92672">/</span>ftp<span style="color:#f92672">/</span>certs<span style="color:#f92672">/</span>$<span style="color:#f92672">{</span>DOMAIN<span style="color:#f92672">}/</span>
    chmod 644 <span style="color:#f92672">/</span>srv<span style="color:#f92672">/</span>ftp<span style="color:#f92672">/</span>certs<span style="color:#f92672">/</span>$<span style="color:#f92672">{</span>DOMAIN<span style="color:#f92672">}/*</span>
<span style="color:#f92672">}</span>
 
unchanged_cert<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
   local DOMAIN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${1}&#34;</span> KEYFILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${2}&#34;</span> CERTFILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${3}&#34;</span> FULLCHAINFILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${4}&#34;</span> CHAINFILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${5}&#34;</span>
   <span style="color:#960050;background-color:#1e0010">##</span> nothing yet<span style="color:#f92672">..</span>
<span style="color:#f92672">}</span>

startup_hook<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#960050;background-color:#1e0010">##</span> This hook is called before the cron command to <span style="color:#66d9ef">do</span> some initial tasks
  <span style="color:#960050;background-color:#1e0010">##</span> <span style="color:#f92672">(</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">g</span><span style="color:#f92672">.</span> starting a webserver<span style="color:#f92672">).</span>
   <span style="color:#66d9ef">for</span> i in <span style="color:#a6e22e">$</span><span style="color:#f92672">(</span>awk <span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#f92672">{</span> print $1 <span style="color:#f92672">}</span> <span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#f92672">/&lt;</span>PATH<span style="color:#f92672">&gt;/</span>dehydrated<span style="color:#f92672">/</span>dehydrated<span style="color:#f92672">.</span><span style="color:#a6e22e">domains</span> <span style="color:#f92672">)</span> <span style="color:#f92672">;</span> <span style="color:#66d9ef">do</span>
      CERTPATH<span style="color:#f92672">=/</span>srv<span style="color:#f92672">/</span>ftp<span style="color:#f92672">/</span>certs<span style="color:#f92672">/</span>$i
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#f92672">!</span> <span style="color:#f92672">-</span>d $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">}</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
         <span style="color:#f92672">[[</span> $<span style="color:#f92672">(</span>stat <span style="color:#f92672">-</span>c <span style="color:#f92672">%</span>a $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">})</span> <span style="color:#f92672">-</span>ne 770 <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
         <span style="color:#f92672">[[</span> $<span style="color:#f92672">(</span>stat <span style="color:#f92672">-</span>c <span style="color:#f92672">%</span>U $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">})</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&lt;USER THE CERTS ARE CREATED BY&gt;&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
         <span style="color:#f92672">[[</span> $<span style="color:#f92672">(</span>stat <span style="color:#f92672">-</span>c <span style="color:#f92672">%</span>G $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">})</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;ftp&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then 
           echo <span style="color:#e6db74">&#34;Creating, chmod, chown FTP directory for $i&#34;</span>
           mkdir <span style="color:#f92672">-</span>p $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">}</span>
           chown <span style="color:#f92672">&lt;</span>USER THE CERTS ARE CREATED BY<span style="color:#f92672">&gt;:</span>ftp $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">}</span>
           chmod 770 $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">}</span>
      fi
   done
   <span style="color:#66d9ef">for</span> i in <span style="color:#a6e22e">$</span><span style="color:#f92672">(</span>cat <span style="color:#f92672">/&lt;</span>PATH<span style="color:#f92672">&gt;/</span>dehydrated<span style="color:#f92672">/</span>dehydrated<span style="color:#f92672">.</span><span style="color:#a6e22e">domains</span><span style="color:#f92672">)</span> <span style="color:#f92672">;</span> <span style="color:#66d9ef">do</span>
      <span style="color:#960050;background-color:#1e0010">##</span> Now check that the zone owner has a CNAME pointing to us <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">this</span> domain
      CNAME<span style="color:#f92672">=</span>$<span style="color:#f92672">(</span>dig _acme<span style="color:#f92672">-</span>challenge<span style="color:#f92672">.</span><span style="color:#a6e22e">$i</span> CNAME <span style="color:#f92672">+</span><span style="color:#66d9ef">short</span><span style="color:#f92672">)</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#f92672">-</span>z $<span style="color:#f92672">{</span>CNAME<span style="color:#f92672">}</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
        echo <span style="color:#e6db74">&#34;There is no CNAME pointing here for $i in the DNS&#34;</span>
        exit 1
      fi
  done
  
<span style="color:#f92672">}</span>

exit_hook<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#960050;background-color:#1e0010">##</span> This hook is called at the end of the cron command and can be used to
  <span style="color:#960050;background-color:#1e0010">##</span> <span style="color:#66d9ef">do</span> some <span style="color:#a6e22e">final</span> <span style="color:#f92672">(</span>cleanup or other<span style="color:#f92672">)</span> tasks<span style="color:#f92672">.</span>

  <span style="color:#f92672">:</span>
<span style="color:#f92672">}</span>

invalid_challenge<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    local DOMAIN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${1}&#34;</span> RESPONSE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${2}&#34;</span>

    <span style="color:#960050;background-color:#1e0010">##</span> This hook is called <span style="color:#66d9ef">if</span> the challenge response has failed<span style="color:#f92672">,</span> so domain
    <span style="color:#960050;background-color:#1e0010">##</span> owners can be aware and act accordingly<span style="color:#f92672">.</span>
    <span style="color:#960050;background-color:#1e0010">#</span>
    <span style="color:#960050;background-color:#1e0010">##</span> Parameters<span style="color:#f92672">:</span>
    <span style="color:#960050;background-color:#1e0010">##</span> <span style="color:#f92672">-</span> DOMAIN
    <span style="color:#960050;background-color:#1e0010">##</span>   The primary domain name<span style="color:#f92672">,</span> i<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">.</span> the certificate common
    <span style="color:#960050;background-color:#1e0010">##</span>   name <span style="color:#f92672">(</span>CN<span style="color:#f92672">).</span>
    <span style="color:#960050;background-color:#1e0010">##</span> <span style="color:#f92672">-</span> RESPONSE
    <span style="color:#960050;background-color:#1e0010">##</span>   The response that the verification server returned
<span style="color:#f92672">}</span>

request_failure<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    local STATUSCODE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${1}&#34;</span> REASON<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${2}&#34;</span> REQTYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${3}&#34;</span>

    <span style="color:#960050;background-color:#1e0010">##</span> This hook is called when an HTTP request <span style="color:#a6e22e">fails</span> <span style="color:#f92672">(</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">g</span><span style="color:#f92672">.,</span> when the ACME
    <span style="color:#960050;background-color:#1e0010">##</span> server is busy<span style="color:#f92672">,</span> returns an error<span style="color:#f92672">,</span> etc<span style="color:#f92672">).</span> It will be called upon any
    <span style="color:#960050;background-color:#1e0010">##</span> response code that does not start with <span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">.</span> Useful to alert admins
    <span style="color:#960050;background-color:#1e0010">##</span> about problems with requests<span style="color:#f92672">.</span>
    <span style="color:#960050;background-color:#1e0010">#</span>
    <span style="color:#960050;background-color:#1e0010">##</span> Parameters<span style="color:#f92672">:</span>
    <span style="color:#960050;background-color:#1e0010">##</span> <span style="color:#f92672">-</span> STATUSCODE
    <span style="color:#960050;background-color:#1e0010">##</span>   The HTML status code that originated the error<span style="color:#f92672">.</span>
    <span style="color:#960050;background-color:#1e0010">##</span> <span style="color:#f92672">-</span> REASON
    <span style="color:#960050;background-color:#1e0010">##</span>   The specified reason <span style="color:#66d9ef">for</span> the error<span style="color:#f92672">.</span>
    <span style="color:#960050;background-color:#1e0010">##</span> <span style="color:#f92672">-</span> REQTYPE
    <span style="color:#960050;background-color:#1e0010">##</span>   The kind of request that was <span style="color:#a6e22e">made</span> <span style="color:#f92672">(</span>GET<span style="color:#f92672">,</span> POST<span style="color:#f92672">...)</span>
<span style="color:#f92672">}</span>

HANDLER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;$1&#34;</span><span style="color:#f92672">;</span> shift
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;${HANDLER}&#34;</span> <span style="color:#f92672">=~</span> <span style="color:#f92672">^(</span>deploy_challenge<span style="color:#f92672">|</span>clean_challenge<span style="color:#f92672">|</span>deploy_cert<span style="color:#f92672">|</span>unchanged_cert<span style="color:#f92672">|</span>invalid_challenge<span style="color:#f92672">|</span>request_failure<span style="color:#f92672">|</span>startup_hook<span style="color:#f92672">|</span>exit_hook<span style="color:#f92672">)</span>$ <span style="color:#f92672">]];</span> then
  <span style="color:#e6db74">&#34;$HANDLER&#34;</span> <span style="color:#e6db74">&#34;$@&#34;</span>
fi
</code></pre></div><h2 id="write-a-script-to-download-the-certificates-to-your-dns-servers">Write a script to download the certificates to your DNS servers</h2>
<p>Do something like the following on each servers to download the
certificates from your main certificate server. </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">!/</span>usr<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>env bash

set <span style="color:#f92672">-</span>e
set <span style="color:#f92672">-</span>u
set <span style="color:#f92672">-</span>o pipefail

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $<span style="color:#f92672">{</span>LOGNAME<span style="color:#f92672">}</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;root&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
  echo <span style="color:#e6db74">&#34;Must be root. Exiting...&#34;</span>
  exit 1
fi

<span style="color:#960050;background-color:#1e0010">##</span> depending on what you are using to terminate the TLS connections
<span style="color:#960050;background-color:#1e0010">##</span> you might need to ensure the correct user can access the certificate files
SERVICEAPP<span style="color:#f92672">=</span>$1
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $<span style="color:#f92672">{</span>SERVICEAPP<span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;haproxy&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> $<span style="color:#f92672">{</span>SERVICEAPP<span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;knot-resolver&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
  GROUPUSER<span style="color:#f92672">=</span>$<span style="color:#f92672">{</span>SERVICEAPP<span style="color:#f92672">}</span>
elif <span style="color:#f92672">[[</span> $<span style="color:#f92672">{</span>SERVICEAPP<span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;apache2&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
     <span style="color:#f92672">[[</span> $<span style="color:#f92672">{</span>SERVICEAPP<span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;apache&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
     <span style="color:#f92672">[[</span> $<span style="color:#f92672">{</span>SERVICEAPP<span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;nginx&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
  GROUPUSER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;www-data&#34;</span>
<span style="color:#66d9ef">else</span>
  echo <span style="color:#e6db74">&#34;Unsupported service application. Exiting...&#34;</span>
  exit 1
fi

CERTPATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/certs&#34;</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#f92672">!</span> <span style="color:#f92672">-</span>d $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">}</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> $<span style="color:#f92672">(</span>stat <span style="color:#f92672">-</span>c <span style="color:#f92672">%</span>a $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">})</span> <span style="color:#f92672">-</span>ne 750 <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> $<span style="color:#f92672">(</span>stat <span style="color:#f92672">-</span>c <span style="color:#f92672">%</span>U $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">})</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;root&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> $<span style="color:#f92672">(</span>stat <span style="color:#f92672">-</span>c <span style="color:#f92672">%</span>G $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">})</span> <span style="color:#f92672">!=</span> $<span style="color:#f92672">{</span>GROUPUSER<span style="color:#f92672">}</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
  echo <span style="color:#e6db74">&#34;No ${CERTPATH} directory or permissions not good.&#34;</span>
  echo <span style="color:#e6db74">&#34;Do something like:&#34;</span>
  echo <span style="color:#e6db74">&#34;  sudo mkdir -p ${CERTPATH}&#34;</span>
  echo <span style="color:#e6db74">&#34;  sudo chmod 750 ${CERTPATH}&#34;</span>
  echo <span style="color:#e6db74">&#34;  sudo chown root:${GROUPUSER} ${CERTPATH}&#34;</span>
  echo <span style="color:#e6db74">&#34;Exiting...&#34;</span>
  exit 1
fi

cd $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">}</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#f92672">!</span> <span style="color:#f92672">-</span>f privkey<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> $<span style="color:#f92672">(</span>stat <span style="color:#f92672">-</span>c <span style="color:#f92672">%</span>a privkey<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span><span style="color:#f92672">)</span> <span style="color:#f92672">-</span>ne 640 <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> $<span style="color:#f92672">(</span>stat <span style="color:#f92672">-</span>c <span style="color:#f92672">%</span>U privkey<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;root&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> $<span style="color:#f92672">(</span>stat <span style="color:#f92672">-</span>c <span style="color:#f92672">%</span>G $<span style="color:#f92672">{</span>CERTPATH<span style="color:#f92672">}/</span>privkey<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> $<span style="color:#f92672">{</span>GROUPUSER<span style="color:#f92672">}</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> <span style="color:#f92672">!</span> <span style="color:#f92672">-</span>s privkey<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
  echo <span style="color:#e6db74">&#34;Private key not found or permissions not good. Exiting...&#34;</span>
  exit 1
fi

<span style="color:#960050;background-color:#1e0010">##</span> Use the hostname to figure out the cert CN
CN<span style="color:#f92672">=</span>$<span style="color:#f92672">(</span>hostname <span style="color:#f92672">-</span>f<span style="color:#f92672">)</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;${CN}&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;test1.dnsovertls.nl&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
  CN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dnsovertls.&lt;YOURDOMAIN&gt;&#34;</span>
elif <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;${CN}&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;test2.dnsovertls.nl&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
  CN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dnsovertls1.&lt;YOURDOMAIN&gt;&#34;</span>
fi

tar <span style="color:#f92672">-</span>cf backup<span style="color:#f92672">-</span>$<span style="color:#f92672">(</span>date <span style="color:#f92672">+%</span>s<span style="color:#f92672">).</span><span style="color:#a6e22e">tar</span> <span style="color:#f92672">*.</span><span style="color:#a6e22e">pem</span>


curl <span style="color:#f92672">-</span>s <span style="color:#f92672">--</span>ssl<span style="color:#f92672">-</span>reqd <span style="color:#f92672">--</span>tlsv1 <span style="color:#f92672">-</span>O ftp<span style="color:#f92672">:</span><span style="color:#75715e">//ns1.acme.&lt;YOURDOMAIN&gt;:21/certs/${CN}/cert.pem
</span><span style="color:#75715e"></span>curl <span style="color:#f92672">-</span>s <span style="color:#f92672">--</span>ssl<span style="color:#f92672">-</span>reqd <span style="color:#f92672">--</span>tlsv1 <span style="color:#f92672">-</span>O ftp<span style="color:#f92672">:</span><span style="color:#75715e">//ns1.acme.&lt;YOURDOMAIN&gt;:21/certs/${CN}/chain.pem
</span><span style="color:#75715e"></span>curl <span style="color:#f92672">-</span>s <span style="color:#f92672">--</span>ssl<span style="color:#f92672">-</span>reqd <span style="color:#f92672">--</span>tlsv1 <span style="color:#f92672">-</span>O ftp<span style="color:#f92672">:</span><span style="color:#75715e">//ns1.acme.&lt;YOURDOMAIN&gt;:21/certs/${CN}/fullchain.pem
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#f92672">!</span> <span style="color:#f92672">-</span>s cert<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> <span style="color:#f92672">!</span> <span style="color:#f92672">-</span>s chain<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> <span style="color:#f92672">!</span> <span style="color:#f92672">-</span>s fullchain<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
  echo <span style="color:#e6db74">&#34;At least one of the certificate files is empty or missing. Exiting...&#34;</span>
  exit 1
fi

cat fullchain<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> <span style="color:#f92672">&gt;</span> keycert<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span>
cat privkey<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> <span style="color:#f92672">&gt;&gt;</span> keycert<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span>
chmod 640 cert<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> chain<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> fullchain<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> keycert<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span>
chown root<span style="color:#f92672">:</span>$<span style="color:#f92672">{</span>GROUPUSER<span style="color:#f92672">}</span> cert<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> chain<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> fullchain<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span> keycert<span style="color:#f92672">.</span><span style="color:#a6e22e">pem</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $<span style="color:#f92672">{</span>SERVICEAPP<span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;haproxy&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> $<span style="color:#f92672">{</span>SERVICEAPP<span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;apache2&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#960050;background-color:#1e0010">\</span>
   <span style="color:#f92672">[[</span> $<span style="color:#f92672">{</span>SERVICEAPP<span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;nginx&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
  INITNAME<span style="color:#f92672">=</span>$<span style="color:#f92672">{</span>SERVICEAPP<span style="color:#f92672">}</span>
elif <span style="color:#f92672">[[</span> $<span style="color:#f92672">{</span>SERVICEAPP<span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;apache&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">;</span> then
  INITNAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;apache2&#34;</span>
<span style="color:#66d9ef">else</span>
  echo <span style="color:#e6db74">&#34;Unsupported service application. Exiting...&#34;</span>
  exit 1
fi
systemctl reload<span style="color:#f92672">-</span>or<span style="color:#f92672">-</span>restart $<span style="color:#f92672">{</span>INITNAME<span style="color:#f92672">}</span>
</code></pre></div>

<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        

        


	 
	 
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1629998312"></script>
    <script src="/js/perfect-scrollbar.min.js?1629998312"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1629998312"></script>
    <script src="/js/jquery.sticky.js?1629998312"></script>
    <script src="/js/featherlight.min.js?1629998312"></script>
    <script src="/js/highlight.pack.js?1629998312"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1629998312"></script>
    <script src="/js/learn.js?1629998312"></script>
    <script src="/js/hugo-learn.js?1629998312"></script>
    
    

  </body>
</html>

